<div class="d-flex justify-content-between align-items-center mb-4">
  <h3><i class="bi bi-pencil"></i> Edit: <%= @file_info[:filename] %></h>
  <div>
    <button type="submit" form="translation-form" class="btn btn-success me-2">
      <i class="bi bi-check-circle me-1"></i> Save Changes
    </button>
    <%= link_to locale_file_path(locale: @file_info[:language]), class: "btn btn-outline-secondary" do %>
      <i class="bi bi-x-circle"></i> Cancel
    <% end %>
  </div>
</div>

<div class="row">
  <div class="col-md-9">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-translate"></i> Parsed Translation</h5>
        <button type="button" class="btn btn-sm btn-light" id="add-key-btn">
          <i class="bi bi-plus-circle me-1"></i> Add Key
        </button>
      </div>
      <div class="card-body">
        <%= form_with url: locale_file_path(locale: @file_info[:language]), method: :patch, local: true, id: "translation-form" do |f| %>
          <%= hidden_field_tag :locale, @file_info[:language] %>
          <%= hidden_field_tag :form_submitted, "true" %>

          <div class="table-responsive">
            <table class="table table-striped table-hover" id="translations-table">
              <thead>
                <tr>
                  <th style="width: 30%;">Key</th>
                  <th style="width: 60%;">Value</th>
                  <th style="width: 10%;"></th>
                </tr>
              </thead>
              <tbody id="translations-tbody">
                <% if @parsed_yaml.present? %>
                  <%= render_editable_yaml_fields(@parsed_yaml) %>
                <% else %>
                  <tr id="empty-row">
                    <td colspan="3" class="text-center text-muted">
                      <i class="bi bi-info-circle"></i> No translations found. Click "Add Key" to add your first translation.
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <%
=begin%>
 <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4 pt-3 border-top">
            <%= submit_tag "Save Changes", class: "btn btn-success btn-lg", id: "save-btn" %>
            <%= link_to "Cancel", locale_file_path(locale: @file_info[:language]), class: "btn btn-outline-secondary btn-lg" %>
          </div> 
<%
=end%>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-info mb-3">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="bi bi-info-circle"></i> File Info</h6>
      </div>
      <div class="card-body">
        <p class="card-text small mb-2">
          <strong>Filename:</strong><br>
          <code><%= @file_info[:filename] %></code>
        </p>
        <p class="card-text small mb-2">
          <strong>Language:</strong><br>
          <span class="badge bg-primary"><%= @file_info[:language].upcase %></span>
        </p>
        <p class="card-text small mb-0">
          <strong>Size:</strong><br>
          <%= number_to_human_size(@file_info[:size]) %>
        </p>
      </div>
    </div>

    <div class="card shadow-sm border-success mb-3">
      <div class="card-header bg-success text-white">
        <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Tips</h6>
      </div>
      <div class="card-body">
        <ul class="small mb-0">
          <li>Edit translation values directly in the table</li>
          <li>Use "Add Key" to add new translation keys</li>
          <li>Click <i class="bi bi-trash"></i> to remove a translation key</li>
          <li>Use dot notation for nested keys (e.g., <code>user.name</code>)</li>
        </ul>
      </div>
    </div>

    <div class="card shadow-sm border-warning">
      <div class="card-header bg-warning">
        <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Warning</h6>
      </div>
      <div class="card-body">
        <p class="card-text small mb-0">
          <i class="bi bi-shield-check"></i> Changes will be validated before saving. Make sure all translation keys are properly filled.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Add Key Modal -->
<div class="modal fade" id="addKeyModal" tabindex="-1" aria-labelledby="addKeyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addKeyModalLabel">
          <i class="bi bi-plus-circle me-2"></i>Add New Translation Key
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3" id="section-path-container" style="display: none;">
          <label class="form-label">Adding to section:</label>
          <div class="alert alert-info mb-0 py-2">
            <code id="section-path-display" class="text-primary"></code>
          </div>
        </div>
        <div class="mb-3">
          <label for="newKeyName" class="form-label">Key Name</label>
          <input type="text" class="form-control" id="newKeyName" placeholder="e.g., welcome_message">
          <div class="form-text" id="key-name-help">
            Enter the key name only (without dots for root level keys)
          </div>
        </div>
        <div class="mb-3">
          <label for="newKeyValue" class="form-label">Translation Value</label>
          <input type="text" class="form-control" id="newKeyValue" placeholder="Enter translation value">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirmAddKey">Add Key</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const addKeyBtn = document.getElementById('add-key-btn');
  const addKeyModal = new bootstrap.Modal(document.getElementById('addKeyModal'));
  const confirmAddKeyBtn = document.getElementById('confirmAddKey');
  const tbody = document.getElementById('translations-tbody');
  const newKeyNameInput = document.getElementById('newKeyName');
  const newKeyValueInput = document.getElementById('newKeyValue');
  const sectionPathContainer = document.getElementById('section-path-container');
  const sectionPathDisplay = document.getElementById('section-path-display');
  const keyNameHelp = document.getElementById('key-name-help');
  let currentSectionPath = ''; // Track which section we're adding to

  // Show modal when main Add Key button is clicked
  addKeyBtn.addEventListener('click', function() {
    currentSectionPath = '';
    newKeyNameInput.value = '';
    newKeyValueInput.value = '';
    sectionPathContainer.style.display = 'none';
    keyNameHelp.textContent = 'Enter the key name (use dot notation for nested keys, e.g., user.name)';
    addKeyModal.show();
  });

  // Show modal when section Add Key button is clicked (event delegation)
  document.addEventListener('click', function(e) {
    if (e.target.closest('.add-section-key')) {
      const btn = e.target.closest('.add-section-key');
      currentSectionPath = btn.getAttribute('data-section-path');

      // Clear input and show section path
      newKeyNameInput.value = '';
      newKeyValueInput.value = '';

      // Show the section path as read-only
      sectionPathDisplay.textContent = currentSectionPath;
      sectionPathContainer.style.display = 'block';
      keyNameHelp.textContent = 'Enter only the key name (e.g., title, name)';

      // Focus on the key name input
      setTimeout(() => {
        newKeyNameInput.focus();
      }, 100);

      addKeyModal.show();
    }
  });

  // Add new key when confirmed
  confirmAddKeyBtn.addEventListener('click', function() {
    const keyNameInput = newKeyNameInput.value.trim();
    const keyValue = newKeyValueInput.value;

    if (!keyNameInput) {
      alert('Please enter a key name');
      return;
    }

    // Build the full key path
    const fullKeyPath = currentSectionPath ? currentSectionPath + '.' + keyNameInput : keyNameInput;

    // Remove empty row if it exists
    const emptyRow = document.getElementById('empty-row');
    if (emptyRow) {
      emptyRow.remove();
    }

    // Create field name for Rails form
    const fieldName = 'translations[' + fullKeyPath.split('.').join('][') + ']';

    // Display key name (just the entered part)
    const displayKey = keyNameInput;

    // Create new table row
    const newRow = document.createElement('tr');
    newRow.className = 'editable-row';
    newRow.innerHTML = `
      <td>${displayKey}</td>
      <td>
        <input type="text" name="${fieldName}" value="${keyValue}" class="form-control form-control-sm" placeholder="Enter translation value">
      </td>
      <td style="width: 80px;">
        <button type="button" class="btn btn-sm btn-outline-danger delete-field" title="Delete this key">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;

    // If adding to a section, find the section and add after it
    if (currentSectionPath) {
      // Find the section header row
      const sectionHeaders = tbody.querySelectorAll('.section-header');
      let targetSection = null;

      sectionHeaders.forEach(header => {
        const btn = header.querySelector('.add-section-key');
        if (btn && btn.getAttribute('data-section-path') === currentSectionPath) {
          targetSection = header;
        }
      });

      if (targetSection) {
        // Insert after the section header
        targetSection.insertAdjacentElement('afterend', newRow);
      } else {
        // Fallback: add to end
        tbody.appendChild(newRow);
      }
    } else {
      // Add to the end if no specific section
      tbody.appendChild(newRow);
    }

    // Close modal
    addKeyModal.hide();
    currentSectionPath = '';
  });

  // Handle delete buttons (use event delegation)
  document.addEventListener('click', function(e) {
    if (e.target.closest('.delete-field')) {
      const row = e.target.closest('tr');
      if (confirm('Are you sure you want to delete this translation key?')) {
        row.remove();

        // If no more rows, show empty message
        const remainingRows = tbody.querySelectorAll('tr.editable-row, tr.section-header');
        if (remainingRows.length === 0) {
          tbody.innerHTML = `
            <tr id="empty-row">
              <td colspan="3" class="text-center text-muted">
                <i class="bi bi-info-circle"></i> No translations found. Click "Add Key" to add your first translation.
              </td>
            </tr>
          `;
        }
      }
    }
  });
});
</script>

<style>
.editable-row:hover {
  background-color: #f8f9fa;
}

.editable-row td {
  vertical-align: middle;
}

.form-control-sm {
  font-size: 0.875rem;
}

#translations-table tbody tr.bg-light {
  font-weight: 500;
}

.section-header td {
  vertical-align: middle;
}

.section-header:hover {
  background-color: #e9ecef !important;
}

.add-section-key {
  transition: all 0.2s ease;
}

.add-section-key:hover {
  transform: scale(1.1);
}
</style>
